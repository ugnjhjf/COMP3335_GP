# 系統架構說明 - 九個模組的職責與執行流程

## 一、各模組負責的工作

### 1. **main.py** - 主程式入口模組
- 負責啟動 HTTP 伺服器
- 在伺服器啟動時測試資料庫連線
- 初始化並啟動 `SimpleAPIServer`
- 監聽指定端口（預設 8000）等待請求

### 2. **db_connector.py** - 資料庫連接模組
- 管理資料庫連線設定（主機、端口、使用者、密碼、資料庫名稱）
- 提供 `get_db_connection()` 函數建立資料庫連線
- 提供 `test_db_connection()` 函數測試連線是否成功
- 設定連線參數（字符集、游標類型、自動提交）

### 3. **db_query.py** - 資料庫查詢模組
- 提供 `db_query()` 執行 SELECT 查詢並返回結果
- 提供 `db_execute()` 執行 INSERT/UPDATE/DELETE 並返回影響行數
- 提供 `getTableColumns()` 獲取資料表欄位資訊
- 提供 `checkPrimaryKey()` 檢查主鍵是否完整
- 提供 `checkUpdatableColumns()` 檢查更新欄位是否在允許清單中

### 4. **privilege_controller.py** - 權限控制模組
- 定義有效角色（student, guardian, aro, dro, root）
- 定義各角色可存取的資料表清單（ROLE_TABLES）
- 定義各角色對各資料表的操作權限（RolePrivileges）
- 提供 `parse_bearer_role()` 從 HTTP 標頭解析使用者角色和 ID
- 提供 `buildRangeFilter()` 根據角色權限建立資料範圍過濾條件
- 定義外鍵關聯（FKLink）用於 JOIN 查詢

### 5. **communicator.py** - 通訊工具模組
- 提供 `json_response()` 發送 JSON 格式的 HTTP 回應
- 提供 `text_response()` 發送文字格式的 HTTP 回應
- 提供 `read_json()` 從 HTTP 請求讀取 JSON 資料
- 處理 CORS 標頭以支援跨域請求

### 6. **logger.py** - 日誌記錄模組
- 提供 `logDataUpdate()` 函數記錄資料更新操作
- 將使用者 ID、角色、SQL 語句寫入 `dataUpdateLog` 資料表
- 用於審計追蹤所有資料變更

### 7. **api_handler.py** - API 請求處理模組
- 繼承 `BaseHTTPRequestHandler` 處理 HTTP 請求
- 處理 OPTIONS 請求（CORS 預檢）
- 處理 GET 請求：
  - `/` - 返回 API 資訊
  - `/retrieveTablesColumns` - 返回使用者可存取的資料表和欄位
- 處理 POST 請求：
  - `/auth/login` - 使用者登入
  - `/auth/logout` - 使用者登出
  - `/performQuery` - 執行資料查詢
  - `/data/update` - 更新資料
  - `/data/delete` - 刪除資料
  - `/data/insert` - 新增資料
- 整合其他模組功能處理業務邏輯

### 8. **auth.py** - 認證與會話管理模組
- 提供 `hash_password()` 使用 SHA-256 和 salt 雜湊密碼
- 提供 `verify_password()` 驗證密碼是否正確
- 提供 `generate_token()` 產生安全的隨機 token
- 提供 `authenticate_user()` 根據 email 和密碼驗證使用者身份
  - 查詢 students、guardians、staffs 三個資料表
  - 根據查詢結果自動判斷使用者角色（student/guardian/aro/dro/root）
- 提供 `create_session()` 建立使用者會話並返回 token
- 提供 `validate_session()` 驗證 token 並返回使用者資訊
- 提供 `logout()` 清除會話
- 管理記憶體中的活躍會話（ACTIVE_SESSIONS）

### 9. **index.html** - 前端使用者介面
- 提供登入表單（email 和密碼輸入）
- 提供資料查詢、新增、修改、刪除的使用者介面
- 處理使用者互動（點擊、輸入、提交）
- 發送 HTTP 請求到後端 API
- 接收並顯示後端回應的資料
- 管理前端狀態（token、使用者資訊、資料表清單）
- 使用 localStorage 持久化會話資訊

---

## 二、系統執行流程（從伺服器啟動到返回結果）

### 階段一：伺服器啟動

1. **main.py** 
   - 執行 `run()` 函數
   - 呼叫 `test_db_connection()` 測試資料庫連線

2. **db_connector.py**
   - `test_db_connection()` 使用 `get_db_connection()` 建立連線
   - 執行 `SELECT 1` 測試連線
   - 返回連線測試結果

3. **main.py**
   - 根據測試結果顯示成功或失敗訊息
   - 建立 `HTTPServer` 實例，指定處理器為 `SimpleAPIServer`
   - 開始監聽端口，等待請求

---

### 階段二：使用者開啟網頁

4. **index.html**
   - 瀏覽器載入 HTML 檔案
   - 執行 `init()` 函數初始化
   - 檢查 localStorage 是否有已儲存的會話
   - 如果有會話，自動載入應用程式；否則顯示登入畫面

---

### 階段三：使用者登入

5. **index.html**
   - 使用者輸入 email 和密碼
   - 點擊登入按鈕觸發 `Login()` 函數
   - 發送 POST 請求到 `/auth/login`

6. **api_handler.py**
   - `do_POST()` 方法接收請求
   - 判斷路徑為 `/auth/login`
   - 使用 `read_json()` 讀取請求資料

7. **communicator.py**
   - `read_json()` 從請求讀取 JSON 資料（email 和 password）

8. **api_handler.py**
   - 呼叫 `authenticate_user()` 驗證使用者

9. **auth.py**
   - `authenticate_user()` 函數執行：
     - 使用 `db_query()` 查詢 students 表
     - 如果找到，使用 `verify_password()` 驗證密碼
     - 如果未找到，查詢 guardians 表
     - 如果仍未找到，查詢 staffs 表
     - 根據查詢結果判斷角色（student/guardian/aro/dro/root）
     - 返回使用者資訊或 None

10. **db_query.py**
    - `db_query()` 使用 `get_db_connection()` 建立連線
    - 執行 SQL 查詢
    - 返回查詢結果

11. **db_connector.py**
    - `get_db_connection()` 建立資料庫連線

12. **auth.py**
    - 如果驗證成功，呼叫 `create_session()` 建立會話
    - 產生 token 並儲存到 ACTIVE_SESSIONS
    - 返回 token 和使用者資訊

13. **api_handler.py**
    - 使用 `json_response()` 發送登入成功回應

14. **communicator.py**
    - `json_response()` 設定 HTTP 狀態碼、標頭、CORS
    - 將 JSON 資料編碼並寫入回應

15. **index.html**
    - 接收回應，儲存 token 到 localStorage
    - 更新使用者資訊
    - 呼叫 `loadApp()` 載入主應用程式

---

### 階段四：使用者查詢資料

16. **index.html**
    - 使用者選擇資料表並點擊查詢
    - 呼叫 `performQuery()` 函數
    - 使用 `handleGet()` 或 `handlePost()` 發送請求到 `/performQuery`
    - 在請求標頭中加入 `Authorization: Bearer <token>`

17. **api_handler.py**
    - `do_POST()` 方法接收請求
    - 判斷路徑為 `/performQuery`
    - 呼叫 `parse_bearer_role()` 解析使用者身份

18. **privilege_controller.py**
    - `parse_bearer_role()` 從標頭提取 token
    - 呼叫 `validate_session()` 驗證 token

19. **auth.py**
    - `validate_session()` 檢查 token 是否存在於 ACTIVE_SESSIONS
    - 檢查是否過期
    - 返回使用者資訊或 None

20. **privilege_controller.py**
    - 如果驗證成功，返回使用者角色和 ID
    - 檢查使用者是否有權限存取該資料表（ROLE_TABLES）

21. **api_handler.py**
    - 如果無權限，返回 403 Forbidden
    - 如果有權限，使用 `getTableColumns()` 獲取資料表欄位

22. **db_query.py**
    - `getTableColumns()` 執行 `SHOW COLUMNS` 查詢
    - 返回欄位資訊

23. **api_handler.py**
    - 根據使用者提供的過濾條件、排序、分頁參數
    - 呼叫 `buildRangeFilter()` 建立資料範圍過濾

24. **privilege_controller.py**
    - `buildRangeFilter()` 根據角色權限建立 WHERE 條件
    - 例如：student 只能看到自己的資料（StuID = 自己的 ID）

25. **api_handler.py**
    - 組合完整的 SQL 查詢語句
    - 呼叫 `db_query()` 執行查詢

26. **db_query.py**
    - `db_query()` 建立連線並執行 SQL
    - 返回查詢結果

27. **api_handler.py**
    - 使用 `json_response()` 返回查詢結果

28. **communicator.py**
    - `json_response()` 格式化並發送 JSON 回應

29. **index.html**
    - 接收查詢結果
    - 在表格中顯示資料
    - 更新使用者介面

---

### 階段五：使用者更新資料

30. **index.html**
    - 使用者修改資料並點擊儲存
    - 發送 POST 請求到 `/data/update`

31. **api_handler.py**
    - `do_POST()` 接收請求
    - 驗證使用者身份和權限
    - 檢查主鍵是否完整（`checkPrimaryKey()`）
    - 檢查更新欄位是否允許（`checkUpdatableColumns()`）

32. **db_query.py**
    - `checkPrimaryKey()` 和 `checkUpdatableColumns()` 執行驗證

33. **api_handler.py**
    - 如果驗證通過，呼叫 `db_execute()` 執行 UPDATE

34. **db_query.py**
    - `db_execute()` 執行 SQL 更新
    - 返回影響的行數

35. **api_handler.py**
    - 如果更新成功，呼叫 `logDataUpdate()` 記錄操作

36. **logger.py**
    - `logDataUpdate()` 將操作記錄寫入 `dataUpdateLog` 表

37. **api_handler.py**
    - 使用 `json_response()` 返回更新結果

38. **index.html**
    - 接收回應並更新介面

---

## 三、完整執行流程圖

```
伺服器啟動：
main.py 
  -> db_connector.py (測試連線)
  -> HTTPServer 啟動監聽

使用者登入：
index.html (發送請求)
  -> api_handler.py (接收 POST /auth/login)
  -> communicator.py (讀取 JSON)
  -> auth.py (authenticate_user)
    -> db_query.py (查詢資料庫)
      -> db_connector.py (建立連線)
  -> auth.py (create_session)
  -> api_handler.py (json_response)
  -> communicator.py (發送回應)
  -> index.html (儲存 token，載入應用)

使用者查詢：
index.html (發送請求)
  -> api_handler.py (接收 POST /performQuery)
  -> privilege_controller.py (parse_bearer_role)
    -> auth.py (validate_session)
  -> privilege_controller.py (檢查權限)
  -> db_query.py (getTableColumns)
    -> db_connector.py (建立連線)
  -> privilege_controller.py (buildRangeFilter)
  -> db_query.py (執行查詢)
    -> db_connector.py (建立連線)
  -> api_handler.py (json_response)
  -> communicator.py (發送回應)
  -> index.html (顯示結果)

使用者更新：
index.html (發送請求)
  -> api_handler.py (接收 POST /data/update)
  -> privilege_controller.py (驗證身份)
  -> db_query.py (checkPrimaryKey, checkUpdatableColumns)
  -> db_query.py (db_execute)
    -> db_connector.py (建立連線)
  -> logger.py (logDataUpdate)
    -> db_connector.py (建立連線)
  -> api_handler.py (json_response)
  -> communicator.py (發送回應)
  -> index.html (更新介面)
```

---

## 四、模組間依賴關係

- **main.py** 依賴：db_connector, api_handler
- **api_handler.py** 依賴：communicator, privilege_controller, db_query, logger, auth
- **auth.py** 依賴：db_query
- **db_query.py** 依賴：db_connector
- **privilege_controller.py** 依賴：auth（動態導入）
- **logger.py** 依賴：db_connector
- **communicator.py** 獨立模組（無依賴）
- **index.html** 獨立前端（透過 HTTP 與後端通訊）

