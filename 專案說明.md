# 專案說明

## 一、總體架構

本系統採用三層架構設計，包含前端、後端和資料庫三個層級。

### 核心模組

1. **api_handler.py** - API 請求處理核心
   - 處理所有 HTTP 請求（GET、POST）
   - 整合認證、權限控制、資料查詢等功能
   - 實現所有 API 端點（登入、查詢、更新、插入、刪除）

2. **auth.py** - 認證與 Session 管理
   - 使用者身份驗證（email、密碼）
   - Session token 生成與驗證
   - 密碼雜湊（bcrypt）

3. **privilege_controller.py** - 權限控制
   - 角色定義（student、guardian、aro、dro）
   - 角色對應的 table 存取權限
   - 資料範圍過濾（self、All）

4. **db_connector.py** - 資料庫連接管理
   - 角色基礎的 DBMS 使用者連接
   - 動態建立資料庫連接

5. **db_query.py** - 資料庫查詢執行
   - 參數化查詢（防止 SQL 注入）
   - SELECT、INSERT、UPDATE、DELETE 操作

---

## 二、前端防護措施

前端主要負責使用者介面展示和基本輸入處理。

### 核心功能

1. **Token 認證**
   - 使用 Bearer token 進行 API 請求認證
   - Token 儲存在 localStorage 中
   - 實現模組：`frontend/index.html`

2. **Session 管理**
   - 自動儲存和恢復 session
   - 登出時清除本地 session 資料
   - 實現模組：`frontend/index.html`

3. **輸入驗證**
   - 基本的前端輸入檢查（email、密碼非空）
   - 實現模組：`frontend/index.html`



---

## 三、後端防護措施

後端實現多層安全防護機制，確保系統安全。

### 核心功能

1. **SQL 注入防護**
   - 參數化查詢（所有 SQL 語句使用參數綁定）
   - 輸入驗證（table name、column name 白名單驗證）
   - SQL 注入檢測與記錄
   - 實現模組：`db_query.py`、`security.py`、`security_monitor.py`

2. **輸入驗證與清理**
   - Email 格式驗證
   - 密碼強度驗證
   - Table name、column name 格式驗證
   - 輸入清理（移除危險字元）
   - 實現模組：`security.py`

3. **權限控制**
   - 角色基礎存取控制（RBAC）
   - Table 存取白名單驗證
   - 資料範圍過濾（使用者只能存取自己的資料）
   - 實現模組：`privilege_controller.py`、`api_handler.py`

4. **認證與 Session 管理**
   - 密碼雜湊（bcrypt）
   - Session token 生成與驗證
   - Session 過期管理
   - 實現模組：`auth.py`

5. **資料加密**
   - 敏感欄位加密（Id_No、address、phone）
   - 使用 MySQL AES_ENCRYPT/AES_DECRYPT
   - 角色基礎加密金鑰
   - 實現模組：`encryption.py`

6. **安全監控與日誌**
   - SQL 注入嘗試檢測與記錄
   - 策略違反檢測
   - 所有資料庫操作記錄
   - 使用者操作記錄（登入、查詢、更新等）
   - 實現模組：`security_monitor.py`、`logger.py`、`audit_logger.py`

---

## 四、資料庫防護措施

資料庫層實現存取控制和資料保護機制。

### 核心功能

1. **角色基礎權限控制**
   - 為每個角色建立專屬 DBMS 使用者（student、guardian、aro、dro、auth_user）
   - 使用 GRANT 語句精確控制每個使用者的 table 和 column 存取權限
   - 最小權限原則（每個角色只能存取必要的 table 和 column）
   - 實現位置：`database_init_sql/University.sql`

2. **敏感資料加密**
   - 使用 MySQL AES_ENCRYPT/AES_DECRYPT 函數加密敏感欄位
   - 加密欄位：`Id_No`、`address`、`phone`
   - 資料以 VARBINARY/BLOB 類型儲存
   - 實現位置：`database_init_sql/University.sql`（table 定義）、`encryption.py`（加密邏輯）

3. **審計日誌**
   - `accountLog` - 記錄所有使用者操作（登入、查詢、失敗嘗試等）
   - `dataUpdateLog` - 記錄所有資料修改操作
   - `audit_log` - 記錄資料庫存取事件
   - 實現位置：`database_init_sql/University.sql`（table 定義）、`logger.py`、`audit_logger.py`（記錄邏輯）

> accountLog用來記錄登錄相關操作，dataUpdateLog只記錄sql記錄。aduit_log記錄詳細信息供進一步調查。
4. **Session 管理**
   - `sessions` table 儲存 session token 和過期時間
   - 支援 session 驗證和過期檢查
   - 實現位置：`database_init_sql/University.sql`（table 定義）、`auth.py`（管理邏輯）

5. **外鍵約束**
   - 使用 FOREIGN KEY 確保資料完整性
   - 防止孤立資料
   - 實現位置：`database_init_sql/University.sql`

---

